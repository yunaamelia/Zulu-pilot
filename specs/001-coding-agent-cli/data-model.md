# Data Model: Coding Agent CLI

**Created**: 2025-01-27  
**Purpose**: Define core entities and their relationships

## Entities

### FileContext

Represents a file loaded into conversation context for the AI to reference.

**Fields**:

- `path: string` - Absolute or relative file path
- `content: string` - Full file content
- `lastModified: Date` - File modification timestamp
- `size: number` - File size in bytes (optional, for token estimation)
- `estimatedTokens: number` - Estimated token count (optional, calculated)

**Validation Rules**:

- Path MUST be a valid file path (no directory traversal)
- Content MUST be readable text (skip binary files)
- File MUST exist when loaded
- File size MUST be reasonable (< 1MB default limit)

**State Transitions**:

- `unloaded` → `loaded` (via `/add` command)
- `loaded` → `unloaded` (via `/clear` command or context reset)

**Relationships**:

- Many FileContext instances belong to one ContextManager
- FileContext is referenced by ModelProvider for context-aware responses

### ModelProvider (Interface)

Abstract interface for AI model providers. Not a concrete entity, but defines the contract.

**Methods**:

- `streamResponse(prompt: string, context: FileContext[]): AsyncGenerator<string>`
- `generateResponse(prompt: string, context: FileContext[]): Promise<string>`

**Implementations**:

- `OllamaProvider` - Local Ollama instance
- `GeminiProvider` - Google Gemini API
- `OpenAIProvider` - OpenAI/DeepSeek/Groq APIs
- `GoogleCloudProvider` - Google Cloud AI Platform models

**Configuration**:

- Each provider has provider-specific config (API keys, base URLs, model names)
- Configuration loaded from `~/.zulu-pilotrc` or command-line flags

### CodeChange

Represents a proposed modification to a file generated by the AI.

**Fields**:

- `filePath: string` - Target file path
- `originalContent: string` - Current file content (or empty if new file)
- `newContent: string` - Proposed new content
- `changeType: 'add' | 'modify' | 'delete'` - Type of change
- `diff: string` - Unified diff format for display
- `lineNumbers: { start: number, end: number }` - Affected line range (optional)

**Validation Rules**:

- File path MUST be valid and within project directory
- Change type MUST match content state (delete = empty newContent)
- Diff MUST be parseable and valid

**State Transitions**:

- `proposed` → `approved` → `applied` (user approves, file updated)
- `proposed` → `rejected` (user rejects, change discarded)

**Relationships**:

- CodeChange is generated by ModelProvider
- CodeChange is applied by FilePatcher
- Multiple CodeChange instances can target different files in one AI response

### Configuration

User preferences and provider settings stored in config file.

**Fields**:

- `provider: string` - Default provider name ('ollama', 'gemini', 'openai', 'googleCloud')
- `model: string` - Default model name (e.g., 'qwen2.5-coder')
- `providers: Record<string, ProviderConfig>` - Provider-specific configurations
- `tokenEstimation: { charsPerToken: number, safetyMargin: number }` - Token estimation settings

**ProviderConfig Structure**:

```typescript
interface ProviderConfig {
  apiKey?: string; // API key or 'env:VAR_NAME' for env vars
  baseUrl?: string; // Base URL for API
  model?: string; // Default model for this provider
  projectId?: string; // Google Cloud project ID
  region?: string; // Google Cloud region
  [key: string]: any; // Provider-specific options
}
```

**Validation Rules**:

- Provider name MUST be one of supported providers
- API keys MUST be valid format or reference env vars
- Base URLs MUST be valid HTTP/HTTPS URLs

**Storage**:

- File: `~/.zulu-pilotrc` (JSON format)
- Can be overridden by command-line flags

## Relationships Summary

```
ContextManager
  ├── manages → FileContext[] (one-to-many)
  └── uses → TokenEstimator

ModelProvider (interface)
  ├── implemented by → OllamaProvider
  ├── implemented by → GeminiProvider
  ├── implemented by → OpenAIProvider
  └── implemented by → GoogleCloudProvider

ModelProvider
  ├── receives → FileContext[] (for context)
  └── generates → CodeChange[] (in responses)

FilePatcher
  ├── parses → CodeChange[] (from AI response)
  └── applies → CodeChange (to file system)

Configuration
  └── configures → ModelProvider (via provider selection)
```

## State Management

### Context State

- **Empty**: No files loaded
- **Loaded**: One or more files in context
- **Warning**: Context approaching token limit
- **Exceeded**: Context exceeds model's token limit

### Provider State

- **Uninitialized**: Provider not configured
- **Ready**: Provider configured and ready
- **Connecting**: Establishing connection
- **Streaming**: Actively streaming response
- **Error**: Connection or API error occurred

### CodeChange State

- **Parsed**: Extracted from AI response
- **Displayed**: Shown to user as diff
- **Pending**: Awaiting user approval
- **Approved**: User approved, ready to apply
- **Applied**: Successfully written to file
- **Rejected**: User rejected, discarded
